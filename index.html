<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sound Trigger Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center">

<div class="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md space-y-6">

  <h1 class="text-2xl font-bold text-center">
    ðŸ“¢ effect Control Panel [test mode]
  </h1>

  <div class="text-center text-xs text-slate-400">
    Dashboard version <span class="text-emerald-400 font-semibold">v1.01</span>
  </div>

  <div class="bg-slate-700 p-4 rounded-xl space-y-3">

    <div class="flex justify-between">
      <span>PC1 Status</span>
      <span id="pcStatus" class="font-semibold">Checking...</span>
    </div>

    <div class="flex justify-between">
      <span>Sound File</span>
      <span id="soundStatus">Checking...</span>
    </div>

    <div class="flex justify-between">
      <span>Last Seen</span>
      <span id="lastSeen" class="text-sm text-slate-300">â€”</span>
    </div>

  </div>

  <button id="triggerBtn" onclick="triggerSound()"
    class="w-full bg-emerald-600 hover:bg-emerald-700 active:scale-95 transition p-3 rounded-xl font-semibold">
    Trigger Sound
  </button>

  <div class="text-center text-xs text-slate-400">
    Auto refresh every 2 seconds
  </div>

</div>

<script>
const BASE = "https://troll-lab-default-rtdb.asia-southeast1.firebasedatabase.app/soundSystem";

let isOnline = false;
let lastGoodSoundLoaded = null;
let lastGoodSeen = null;

async function fetchData() {
  try {
    const r = await fetch(BASE + ".json?v=" + Date.now());
    const data = await r.json();
    if (!data) return;
    updateStatus(data);
  } catch {
    setOfflineUI();
  }
}

function updateStatus(data) {
  const now = Date.now();
  isOnline = false;

  if (data.lastSeen) {
    const last = new Date(data.lastSeen).getTime();
    isOnline = (now - last) <= 5000;
  }

  const pcEl = document.getElementById("pcStatus");
  const btn = document.getElementById("triggerBtn");

  if (!isOnline) {
    pcEl.textContent = "OFFLINE";
    pcEl.className = "font-semibold text-red-400";

    btn.disabled = true;
    btn.className = "w-full bg-gray-600 cursor-not-allowed p-3 rounded-xl font-semibold";

    return; // ðŸ”´ stop â€” do not overwrite last known values
  }

  // ðŸŸ¢ ONLINE UI
  pcEl.textContent = "ONLINE";
  pcEl.className = "font-semibold text-green-400";

  btn.disabled = false;
  btn.className = "w-full bg-emerald-600 hover:bg-emerald-700 active:scale-95 transition p-3 rounded-xl font-semibold";

  if (data.lastSeen) {
    lastGoodSeen = data.lastSeen;
    document.getElementById("lastSeen").textContent = data.lastSeen;
  }

  if (typeof data.soundLoaded === "boolean") {
    lastGoodSoundLoaded = data.soundLoaded;
  }

  const soundEl = document.getElementById("soundStatus");

  if (lastGoodSoundLoaded === true) {
    soundEl.textContent = "Loaded";
    soundEl.className = "text-green-400";
  } else if (lastGoodSoundLoaded === false) {
    soundEl.textContent = "Missing";
    soundEl.className = "text-yellow-400";
  }
}

function setOfflineUI() {
  isOnline = false;
  const pcEl = document.getElementById("pcStatus");
  pcEl.textContent = "OFFLINE";
  pcEl.className = "font-semibold text-red-400";
}

async function triggerSound() {
  if (!isOnline) return; // ðŸš« hard guard

  await fetch(BASE + "/trigger.json", {
    method: "PUT",
    body: "true"
  });
}

setInterval(fetchData, 2000);
fetchData();
</script>

</body>
</html>
